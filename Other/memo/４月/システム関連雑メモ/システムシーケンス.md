# システムシーケンス

#### Entity
- User
- App
- Server
- Network
- DB

#### データ
- UserID : ユーザに一意のID
- チャットルーム: ユーザが複数持っているチャットルーム
- チャット履歴: チャットルームに紐づくチャット履歴
- AIメッセージ: AIから取得するメッセージ

### シーケンス
目的: AIとの対話型インターフェースで英会話をする

```mermaid
sequenceDiagram
    participant User
    participant App
    participant Server
    participant DB
    participant Network
    Note over App, User: 新規起動の場合はここから
    User->>+App: Appを起動する
    App->>+Server: 起動要求
    Server->>+DB: UseIdからテーブル検索、なければ作成
    DB->>+Server: ユーザ情報
    Server->>+Network: 最初のAI返答を生成要求
    Network-->>-Server: AI返答取得
    Server->>+DB: 返答をDBに保管
    Server->>+App: 返答とUserID、ChatRoomIDを返答
    App->>+User: AI返答を表示
    Note over App, User: 新規起動でない場合はここから
    User->>+App: 自分のメッセージを送信
    App->>+Server: UserID、ChatRoomID、Userのメッセージを送信
    Server->>+Network:音声データ加工
    Network->>+Server: 音声テキスト
    Server->>+DB:テキスト保存
    DB->>+Server: 会話履歴返答
    Server->>+App:音声データテキスト返答
    App->>+Server:AI返答をリクエスト
    Server->>+DB: 会話内容を取得
    DB->>+Server: 返答
    Server->>+Server: データ加工
    Server->>+Network: AI返答要求
    Network-->>-Server: AI返答取得
    Server->>+DB: 返答をDBに保存
    DB->>+Server: ChatRoomの全履歴を取得
    Server->>+App: ChatRoomの全履歴を返答
    App->>+User: Chatを表示
```


### 背景
- なぜサーバを噛ませているのか
    - クライアントサイドをシンプルにするため
        - KMMのマルチプラットフォームを意識-> モジュール構成が最初から通常より複雑なのでできるだけこちらはシンプルにしたい
        - Sharedモジュール分割が難しかった
    - 将来的にはサーバをそのままCloudRunに突っ込めるので公開もまあ容易
- DBの役割は？
    - ユーザのチャット内容を保存
- Networkの役割は？
    - GCP Cloud Strageへのユーザの音声データ保存
    - TextToSpeechリクエスト
    - ChatCompletionへのリクエスト

